<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leona/Eleny Config Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
    <style>
        .form-section {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            border-top: 4px solid transparent;
        }
        .section-core { border-color: #3b82f6; }
        .section-rag { border-color: #8b5cf6; }
        .section-sched { border-color: #ec4899; }
        .section-media { border-color: #f59e0b; }
        .section-routing { border-color: #10b981; }
        .section-reminders { border-color: #06b6d4; }
        .section-tokens { border-color: #64748b; }
        
        input[type="text"], input[type="email"], input[type="number"], input[type="time"], input[type="datetime-local"], textarea, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            font-size: 0.875rem;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            ring: 2px solid #3b82f6;
        }
        label {
            font-weight: 600;
            color: #334155;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: block;
            margin-bottom: 2px;
        }
        .card-list-item {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #ef4444;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .subsection-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #475569;
            margin-bottom: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
        }

        /* Custom Toggle Switch Style */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }

    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-800">

    <!-- Toast -->
    <div id="toast" class="fixed top-5 right-5 z-50 transform transition-transform duration-300 translate-x-full bg-slate-800 text-white px-6 py-3 rounded shadow-lg flex items-center gap-3">
        <i class="fas fa-info-circle"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto p-6">
        
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Assistant Configuration</h1>
                <p class="text-slate-500 mt-1">Full Schema Generator (Asistentes, Scheduling, Media, Tokens)</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="loadConfigFile(this)">
                <button onclick="document.getElementById('fileInput').click()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                    <i class="fas fa-upload"></i> Load JSON
                </button>
                <button onclick="copyToClipboard()" class="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                    <i class="fas fa-copy"></i> Copy JSON
                </button>
                <button onclick="saveConfigFile()" class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2">
                    <i class="fas fa-download"></i> Save File
                </button>
            </div>
        </div>

        <form id="configForm" onsubmit="return false;">
            
            <!-- 1. ASISTENTES: Core & Persona -->
            <div class="form-section section-core">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-user-circle text-blue-500 mr-2"></i> Asistentes: Core Info</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label>Assistant Name</label><input type="text" id="assistantName" value="Vale"></div>
                    <div><label>Assistant Title</label><input type="text" id="assistantNameTitle" value="la asistente"></div>
                    <div><label>Personality</label><input type="text" id="assistantPersonality" value="amigable y formal"></div>
                    <div>
                        <label>Assistant Type</label>
                        <select id="assistantType">
                            <option value="doctor">Doctor (Individual)</option>
                            <option value="clinic">Clinic (Organization)</option>
                        </select>
                    </div>
                    <div><label>LangGraph ID</label><input type="text" id="langgraphAssistantId" class="font-mono"></div>
                </div>

                <div class="mb-6">
                    <label>Assistant RAG (Instructions)</label>
                    <textarea id="assistantRag" rows="3" class="font-mono text-xs"></textarea>
                </div>

                <div class="subsection-title">Doctor / Business Details</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label>Doctor Name</label><input type="text" id="doctorName"></div>
                    <div><label>Doctor Title</label><input type="text" id="doctorNameTitle" value="la doctora"></div>
                    <div><label>Doctor Email</label><input type="email" id="doctorEmail"></div>
                    <div><label>Office Phone</label><input type="text" id="doctorOfficePhone"></div>
                    <div><label>Address</label><input type="text" id="doctorAddress"></div>
                    <div><label>Timezone</label>
                        <select id="doctorTimezone">
                            <option value="America/Mexico_City">America/Mexico_City</option>
                            <option value="America/Hermosillo">America/Hermosillo</option>
                            <option value="America/New_York">America/New_York</option>
                            <option value="UTC">UTC</option>
                        </select>
                    </div>
                    <div>
                        <label>Specialty Category</label>
                        <select id="doctorSpecialty">
                            <option value="other">Otra</option>
                            <option value="generalSurgery">Cirugía General</option>
                            <option value="dermatology">Dermatología</option>
                            <option value="gynecologyObstetrics">Ginecología y Obstetricia</option>
                            <option value="pediatrics">Pediatría</option>
                            <option value="psychiatry">Psiquiatría</option>
                            <option value="nutrition">Nutrición</option>
                        </select>
                    </div>
                    <div><label>Custom Specialty (Display)</label><input type="text" id="customSpecialty"></div>
                </div>

                <div class="subsection-title">Direct Communication Handover</div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label>Target (Who)</label><input type="text" id="directCommunication.communicationTarget"></div>
                    <div><label>Availability (When)</label><input type="text" id="directCommunication.communicationWhen"></div>
                    <div><label>Method (How)</label><input type="text" id="directCommunication.communicationMethod"></div>
                    <div><label>Situations (Why)</label><input type="text" id="directCommunication.communicationSituations"></div>
                </div>
            </div>

            <!-- 2. ASISTENTES: RAG & Apology -->
            <div class="form-section section-rag">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-brain text-violet-500 mr-2"></i> RAG & Apologies</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div><label>Corpus / VectorStore ID</label><input type="text" id="ragConfig.corpusId" class="font-mono"></div>
                    <div>
                        <label>Search Mode</label>
                        <select id="ragConfig.mode">
                            <option value="KNN">KNN</option>
                            <option value="ANN">ANN</option>
                        </select>
                    </div>
                    <div><label>Top K Results</label><input type="number" id="ragConfig.topK" value="3"></div>
                </div>

                <div class="subsection-title">Apology Settings (Enable Fallbacks)</div>
                <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Image</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.imageApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.imageApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Video</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.videoApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.videoApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Contact</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.contactApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.contactApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Document</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.documentApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.documentApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Location</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.locationApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.locationApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded border text-center flex flex-col items-center gap-2">
                        <label class="mb-0">Unknown</label>
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="apologySettings.unknownApology" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="apologySettings.unknownApology" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. SCHEDULING -->
            <div class="form-section section-sched">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-calendar-alt text-pink-500 mr-2"></i> Scheduling</h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 bg-slate-50 p-6 rounded">
                    <div><label>Time Between Appts (min)</label><input type="number" id="timeBetweenAppointments" value="0"></div>
                    <div><label>Max Days Before Booking</label><input type="number" id="maxDaysBeforeBooking" value="30"></div>
                    <div><label>Min Appt Buffer (min)</label><input type="number" id="minAppointmentBuffer" value="60"></div>
                    <div>
                        <label>Preference</label>
                        <select id="appointmentSchedulingPreference">
                            <option value="googleCalendar">Google Calendar</option>
                            <option value="otherCalendar">Other Calendar</option>
                        </select>
                    </div>
                    <div class="md:col-span-2"><label>Other Calendar Link</label><input type="text" id="otherCalendarLink"></div>
                    
                    <div class="flex items-center gap-3 mt-4">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="smartSearch" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="smartSearch" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="smartSearch" class="cursor-pointer mb-0">Smart Search</label>
                    </div>
                    <div class="flex items-center gap-3 mt-4">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="agendarCitaFields.requestEmail" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="agendarCitaFields.requestEmail" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="agendarCitaFields.requestEmail" class="cursor-pointer mb-0">Req. Email</label>
                    </div>
                    <div class="flex items-center gap-3 mt-4">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="agendarCitaFields.requestMotivoDeCita" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="agendarCitaFields.requestMotivoDeCita" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="agendarCitaFields.requestMotivoDeCita" class="cursor-pointer mb-0">Req. Reason</label>
                    </div>
                </div>

                <!-- Appt Types -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-500 uppercase">Appointment Types</h3>
                        <button onclick="addAppointmentType()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Type</button>
                    </div>
                    <div id="appointmentTypesList" class="space-y-2"></div>
                </div>

                <!-- Doctors -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-500 uppercase">Doctors / Calendars</h3>
                        <button onclick="addDoctor()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Doctor</button>
                    </div>
                    <div id="doctorsList" class="space-y-4"></div>
                </div>

                <!-- Out of Office -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-500 uppercase">Out of Office Events</h3>
                        <button onclick="addOutOfOffice()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Event</button>
                    </div>
                    <div id="outOfOfficeList" class="space-y-2"></div>
                </div>
            </div>

            <!-- 4. MEDIA -->
            <div class="form-section section-media">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-photo-video text-amber-500 mr-2"></i> Media</h2>
                
                <div class="flex gap-8 mb-6 items-center">
                    <div class="flex items-center gap-3">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="enableMediaSending" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="enableMediaSending" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="enableMediaSending" class="cursor-pointer mb-0">Enable Sending</label>
                    </div>
                    <div><label>Asset Limit</label><input type="number" id="assetLimit" value="5" class="w-20"></div>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-500 uppercase">Media Assets</h3>
                    <button onclick="addMediaAsset()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Asset</button>
                </div>
                <div id="mediaAssetsList" class="space-y-2"></div>
            </div>

            <!-- 5. ROUTING -->
            <div class="form-section section-routing">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-random text-emerald-500 mr-2"></i> Team Routing</h2>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-500 uppercase">Team Transfer Rules</h3>
                    <button onclick="addRoutingRule()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Rule</button>
                </div>
                <div id="routingList" class="space-y-2"></div>
            </div>

            <!-- 6. REMINDERS -->
            <div class="form-section section-reminders">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-bell text-cyan-500 mr-2"></i> Reminders</h2>
                
                <div class="flex gap-8 mb-6 items-center">
                    <div class="flex items-center gap-3">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="sendReminders" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="sendReminders" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="sendReminders" class="cursor-pointer mb-0">Send</label>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="requireConfirmation" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="requireConfirmation" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                        <label for="requireConfirmation" class="cursor-pointer mb-0">Req. Confirmation</label>
                    </div>
                    <div><label>Count</label><input type="number" id="numberOfReminders" value="1" class="w-20"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-3 border rounded bg-slate-50">
                        <div class="text-xs font-bold uppercase mb-2 text-cyan-700">Reminder 1</div>
                        <div><label>Timing (Days before)</label><input type="number" id="reminder1.timing" value="1"></div>
                        <div><label>Template Name</label><input type="text" id="reminder1.templateName" value="base_reminder_1"></div>
                    </div>
                    <div class="p-3 border rounded bg-slate-50">
                        <div class="text-xs font-bold uppercase mb-2 text-cyan-700">Reminder 2</div>
                        <div><label>Timing (Days before)</label><input type="number" id="reminder2.timing" value="0"></div>
                        <div><label>Template Name</label><input type="text" id="reminder2.templateName" value="base_reminder_2"></div>
                    </div>
                </div>
            </div>

            <!-- 7. TEMPLATES -->
            <div class="form-section">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-file-alt text-slate-500 mr-2"></i> Templates</h2>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-slate-500 uppercase">Template List</h3>
                    <button onclick="addTemplate()" class="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">Add Template</button>
                </div>
                <div id="templatesList" class="space-y-2"></div>
            </div>

            <!-- 8. TOKENS -->
            <div class="form-section section-tokens">
                <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-key text-slate-500 mr-2"></i> Tokens & APIs</h2>
                
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">Google Calendar</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div><label>Access Token</label><input type="text" id="tokens.gc.accessToken" class="font-mono text-xs"></div>
                        <div><label>Refresh Token</label><input type="text" id="tokens.gc.refreshToken" class="font-mono text-xs"></div>
                        <div><label>Expires</label><input type="text" id="tokens.gc.expiresDatetime" class="font-mono text-xs"></div>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-slate-500 uppercase mb-2">WhatsApp Cloud API</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div><label>Phone Number ID</label><input type="text" id="tokens.wa.phoneNumberId" class="font-mono text-xs"></div>
                        <div><label>WABA ID</label><input type="text" id="tokens.wa.wabaId" class="font-mono text-xs"></div>
                        <div class="md:col-span-2"><label>Token</label><input type="text" id="tokens.wa.token" class="font-mono text-xs"></div>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <script>
        const DAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

        // --- HELPERS ---
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-x-full');
            setTimeout(() => t.classList.add('translate-x-full'), 3000);
        }

        // --- LIST BUILDERS ---

        function addAppointmentType(data = null) {
            const list = document.getElementById('appointmentTypesList');
            const id = data ? data.key : `type_${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'card-list-item appt-type-card';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="grid grid-cols-4 gap-2">
                    <div class="col-span-1"><label>ID</label><input type="text" class="appt-key font-mono" value="${id}"></div>
                    <div class="col-span-2"><label>Description</label><input type="text" class="appt-desc" value="${data?.description||''}"></div>
                    <div class="col-span-1"><label>Duration</label><input type="number" class="appt-dur" value="${data?.duration||30}"></div>
                    <div class="col-span-4"><label>Instructions</label><input type="text" class="appt-instr" value="${data?.additionalInstructions||''}"></div>
                </div>
            `;
            list.appendChild(div);
        }

        function addDoctor(data = null) {
            const list = document.getElementById('doctorsList');
            const id = data ? data.key : `doc_${Date.now()}`;
            
            // Generate checkboxes for appt types
            const typeCards = document.querySelectorAll('.appt-type-card');
            let checks = '<div class="flex flex-wrap gap-2 mt-1">';
            typeCards.forEach(c => {
                const k = c.querySelector('.appt-key').value;
                const chk = (data?.appointmentTypes?.includes(k)) ? 'checked' : '';
                const uniqueId = `doc_type_${id}_${k.replace(/\W/g,'')}`;
                // Use mini-toggle structure from earlier version logic
                 checks += `
                    <label class="flex items-center space-x-2 cursor-pointer bg-slate-100 p-2 rounded hover:bg-slate-200 transition">
                        <div class="relative inline-block w-8 align-middle select-none">
                            <input type="checkbox" value="${k}" class="doc-types toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-2 appearance-none cursor-pointer top-0" ${chk} style="height:1rem; width:1rem;"/>
                            <div class="toggle-label block overflow-hidden h-4 rounded-full bg-gray-300 cursor-pointer" style="height:1rem;"></div>
                        </div>
                        <span class="truncate text-sm font-medium">${k}</span>
                    </label>
                `;
            });
            checks += '</div>';

            // Schedule Grid
            let grid = '<div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2 border-t pt-2">';
            DAYS.forEach(day => {
                let slots = data?.schedule?.[day] || [{},{},{}];
                while(slots.length < 3) slots.push({});
                const inputs = slots.map((s,i) => `
                    <div class="flex gap-1">
                        <input type="time" class="doc-start p-0 text-xs w-16" data-day="${day}" data-idx="${i}" value="${s.start||''}">
                        <input type="time" class="doc-end p-0 text-xs w-16" data-day="${day}" data-idx="${i}" value="${s.end||''}">
                    </div>
                `).join('');
                grid += `
                    <div class="bg-white p-2 border rounded">
                        <div class="text-xs font-bold uppercase mb-1 text-slate-400">${day}</div>
                        <div class="flex flex-col gap-1">${inputs}</div>
                    </div>
                `;
            });
            grid += '</div>';

            const div = document.createElement('div');
            div.className = 'card-list-item doctor-card';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label>Doctor ID</label><input type="text" class="doc-key font-mono" value="${id}"></div>
                    <div><label>Calendar ID</label><input type="text" class="doc-cal" value="${data?.selectedCalendarId||''}"></div>
                    <div class="col-span-2"><label>Appt Types</label>${checks}</div>
                </div>
                <label>Weekly Schedule (Start - End)</label>
                ${grid}
            `;
            list.appendChild(div);
        }

        function addOutOfOffice(data = null) {
            const list = document.getElementById('outOfOfficeList');
            const div = document.createElement('div');
            div.className = 'card-list-item ooo-card flex gap-2 items-end';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="flex-1"><label>Event Name</label><input type="text" class="ooo-name" value="${data?.oooEventName||''}"></div>
                <div class="w-32"><label>Doctor ID</label><input type="text" class="ooo-doc" value="${data?.doctorId||''}"></div>
                <div class="w-36"><label>Start</label><input type="datetime-local" class="ooo-start" value="${data?.oooEventStart||''}"></div>
                <div class="w-36"><label>End</label><input type="datetime-local" class="ooo-end" value="${data?.oooEventEnd||''}"></div>
                <input type="hidden" class="ooo-id" value="${data?.oooEventId || 'evt_'+Date.now()}">
            `;
            list.appendChild(div);
        }

        function addMediaAsset(data = null) {
            const list = document.getElementById('mediaAssetsList');
            const id = data ? data.key : `media_${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'card-list-item media-card';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="grid grid-cols-4 gap-2">
                    <div class="col-span-1"><label>ID</label><input type="text" class="media-key font-mono" value="${id}"></div>
                    <div class="col-span-3"><label>Title</label><input type="text" class="media-title" value="${data?.title||''}"></div>
                    <div class="col-span-4"><label>Description</label><input type="text" class="media-desc" value="${data?.description||''}"></div>
                    <div class="col-span-4"><label>Caption</label><input type="text" class="media-cap" value="${data?.caption||''}"></div>
                    <div class="col-span-2"><label>Kind</label>
                        <select class="media-kind">
                            <option value="images" ${data?.kind==='images'?'selected':''}>Images</option>
                            <option value="documents" ${data?.kind==='documents'?'selected':''}>Documents</option>
                            <option value="videos" ${data?.kind==='videos'?'selected':''}>Videos</option>
                        </select>
                    </div>
                    <div class="col-span-2"><label>Content Type</label>
                        <select class="media-type">
                            <option value="application/pdf" ${data?.contentType==='application/pdf'?'selected':''}>PDF</option>
                            <option value="image/jpeg" ${data?.contentType==='image/jpeg'?'selected':''}>JPEG</option>
                            <option value="image/png" ${data?.contentType==='image/png'?'selected':''}>PNG</option>
                            <option value="video/mp4" ${data?.contentType==='video/mp4'?'selected':''}>MP4</option>
                        </select>
                    </div>
                </div>
            `;
            list.appendChild(div);
        }

        function addRoutingRule(data = null) {
            const list = document.getElementById('routingList');
            const id = data ? data.key : `member_${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'card-list-item routing-card';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="grid grid-cols-1 gap-2">
                    <div><label>Team Member ID</label><input type="text" class="route-key font-mono" value="${id}"></div>
                    <div><label>Situation (Trigger)</label><input type="text" class="route-sit" value="${data?.situation||''}"></div>
                    <div><label>Data to Gather</label><input type="text" class="route-data" value="${data?.dataToGather||''}"></div>
                </div>
            `;
            list.appendChild(div);
        }

        function addTemplate(data = null) {
            const list = document.getElementById('templatesList');
            const id = data ? data.key : `tpl_${Date.now()}`;
            const div = document.createElement('div');
            div.className = 'card-list-item tpl-card flex gap-2 items-end';
            div.innerHTML = `
                <i class="fas fa-times remove-btn" onclick="this.parentElement.remove()"></i>
                <div class="flex-1"><label>Internal ID</label><input type="text" class="tpl-key font-mono" value="${id}"></div>
                <div class="flex-1"><label>WA Template ID</label><input type="text" class="tpl-wa-id" value="${data?.templateId||''}"></div>
                <div class="w-32"><label>Lang</label><input type="text" class="tpl-lang" value="${data?.languageCode||'es_MX'}"></div>
                <div class="w-32"><label>Status</label>
                    <select class="tpl-status">
                        <option value="APPROVED" ${data?.status==='APPROVED'?'selected':''}>APPROVED</option>
                        <option value="PENDING" ${data?.status==='PENDING'?'selected':''}>PENDING</option>
                    </select>
                </div>
            `;
            list.appendChild(div);
        }

        // --- CORE FUNCTIONS ---

        function getFormData() {
            const val = (id) => document.getElementById(id)?.value || '';
            const bool = (id) => document.getElementById(id)?.checked || false;

            // Maps Builders
            const appointmentTypes = {};
            document.querySelectorAll('.appt-type-card').forEach(c => {
                appointmentTypes[c.querySelector('.appt-key').value] = {
                    description: c.querySelector('.appt-desc').value,
                    duration: parseInt(c.querySelector('.appt-dur').value) || 30,
                    additionalInstructions: c.querySelector('.appt-instr').value
                };
            });

            const doctors = {};
            document.querySelectorAll('.doctor-card').forEach(c => {
                const schedule = {};
                DAYS.forEach(day => {
                    const starts = c.querySelectorAll(`.doc-start[data-day="${day}"]`);
                    const ends = c.querySelectorAll(`.doc-end[data-day="${day}"]`);
                    schedule[day] = Array.from(starts).map((s,i) => ({ start: s.value, end: ends[i].value }));
                });
                const types = Array.from(c.querySelectorAll('.doc-types:checked')).map(cb => cb.value);
                
                doctors[c.querySelector('.doc-key').value] = {
                    selectedCalendarId: c.querySelector('.doc-cal').value,
                    appointmentTypes: types,
                    schedule: schedule
                };
            });

            const mediaAssets = {};
            document.querySelectorAll('.media-card').forEach(c => {
                mediaAssets[c.querySelector('.media-key').value] = {
                    title: c.querySelector('.media-title').value,
                    description: c.querySelector('.media-desc').value,
                    caption: c.querySelector('.media-cap').value,
                    kind: c.querySelector('.media-kind').value,
                    contentType: c.querySelector('.media-type').value
                };
            });

            const teamTransferRules = {};
            document.querySelectorAll('.routing-card').forEach(c => {
                teamTransferRules[c.querySelector('.route-key').value] = {
                    situation: c.querySelector('.route-sit').value,
                    dataToGather: c.querySelector('.route-data').value
                };
            });
            
            const templates = {};
            document.querySelectorAll('.tpl-card').forEach(c => {
                templates[c.querySelector('.tpl-key').value] = {
                    templateId: c.querySelector('.tpl-wa-id').value,
                    languageCode: c.querySelector('.tpl-lang').value,
                    status: c.querySelector('.tpl-status').value
                };
            });

            const outOfOffice = [];
            document.querySelectorAll('.ooo-card').forEach(c => {
                outOfOffice.push({
                    oooEventId: c.querySelector('.ooo-id').value,
                    oooEventName: c.querySelector('.ooo-name').value,
                    doctorId: c.querySelector('.ooo-doc').value,
                    oooEventStart: c.querySelector('.ooo-start').value,
                    oooEventEnd: c.querySelector('.ooo-end').value
                });
            });

            // Available Calendars (Tokens) - Simple passthrough from existing JSON usually, here placeholder
            const availableCalendars = []; 

            return {
                // ASISTENTES COLLECTION
                assistantName: val('assistantName'),
                assistantNameTitle: val('assistantNameTitle'),
                assistantPersonality: val('assistantPersonality'),
                assistantType: val('assistantType'),
                langgraphAssistantId: val('langgraphAssistantId'),
                assistantRag: val('assistantRag'),
                doctorName: val('doctorName'),
                doctorNameTitle: val('doctorNameTitle'),
                doctorEmail: val('doctorEmail'),
                doctorOfficePhone: val('doctorOfficePhone'),
                doctorAddress: val('doctorAddress'),
                doctorTimezone: val('doctorTimezone'),
                doctorSpecialty: val('doctorSpecialty'),
                customSpecialty: val('customSpecialty'),
                
                directCommunication: {
                    communicationTarget: val('directCommunication.communicationTarget'),
                    communicationWhen: val('directCommunication.communicationWhen'),
                    communicationMethod: val('directCommunication.communicationMethod'),
                    communicationSituations: val('directCommunication.communicationSituations')
                },

                apologySettings: {
                    imageApology: bool('apologySettings.imageApology'),
                    videoApology: bool('apologySettings.videoApology'),
                    contactApology: bool('apologySettings.contactApology'),
                    documentApology: bool('apologySettings.documentApology'),
                    locationApology: bool('apologySettings.locationApology'),
                    unknownApology: bool('apologySettings.unknownApology')
                },

                ragConfig: {
                    corpusId: val('ragConfig.corpusId'), // or vectorStoreId logic
                    vectorStoreId: val('ragConfig.corpusId'),
                    mode: val('ragConfig.mode'),
                    topK: parseInt(val('ragConfig.topK')) || 3
                },

                // SCHEDULING
                scheduling: {
                    appointmentTypes,
                    doctors,
                    smartSearch: bool('smartSearch'),
                    timeBetweenAppointments: parseInt(val('timeBetweenAppointments')) || 0,
                    maxDaysBeforeBooking: parseInt(val('maxDaysBeforeBooking')) || 30,
                    minAppointmentBuffer: parseInt(val('minAppointmentBuffer')) || 60,
                    appointmentSchedulingPreference: val('appointmentSchedulingPreference'),
                    otherCalendarLink: val('otherCalendarLink'),
                    agendarCitaFields: {
                        requestEmail: bool('agendarCitaFields.requestEmail'),
                        requestMotivoDeCita: bool('agendarCitaFields.requestMotivoDeCita')
                    },
                    outOfOffice
                },

                // MEDIA
                media: {
                    enableMediaSending: bool('enableMediaSending'),
                    assetLimit: parseInt(val('assetLimit')) || 5,
                    mediaAssets
                },

                // CUSTOM NOTIFICATIONS (Routing)
                customNotifications: {
                    teamTransferRules
                },

                // REMINDERS
                reminders: {
                    sendReminders: bool('sendReminders'),
                    requireConfirmation: bool('requireConfirmation'),
                    numberOfReminders: parseInt(val('numberOfReminders')) || 1,
                    reminder1: {
                        timing: parseInt(val('reminder1.timing')) || 0,
                        templateName: val('reminder1.templateName')
                    },
                    reminder2: {
                        timing: parseInt(val('reminder2.timing')) || 0,
                        templateName: val('reminder2.templateName')
                    }
                },

                // TEMPLATES
                templates,

                // TOKENS
                tokens: {
                    googleCalendar: {
                        accessToken: val('tokens.gc.accessToken'),
                        refreshToken: val('tokens.gc.refreshToken'),
                        expiresDatetime: val('tokens.gc.expiresDatetime'),
                        availableCalendars 
                    },
                    whatsappCloudApi: {
                        phoneNumberId: val('tokens.wa.phoneNumberId'),
                        wabaId: val('tokens.wa.wabaId'),
                        token: val('tokens.wa.token')
                    }
                }
            };
        }

        function populateForm(data) {
            const setVal = (id, v) => { if(document.getElementById(id)) document.getElementById(id).value = v || ''; };
            const setBool = (id, v) => { if(document.getElementById(id)) document.getElementById(id).checked = !!v; };

            // ASISTENTES
            setVal('assistantName', data.assistantName);
            setVal('assistantNameTitle', data.assistantNameTitle);
            setVal('assistantPersonality', data.assistantPersonality);
            setVal('assistantType', data.assistantType);
            setVal('langgraphAssistantId', data.langgraphAssistantId);
            setVal('assistantRag', data.assistantRag);
            setVal('doctorName', data.doctorName);
            setVal('doctorNameTitle', data.doctorNameTitle);
            setVal('doctorEmail', data.doctorEmail);
            setVal('doctorOfficePhone', data.doctorOfficePhone);
            setVal('doctorAddress', data.doctorAddress);
            setVal('doctorTimezone', data.doctorTimezone);
            setVal('doctorSpecialty', data.doctorSpecialty);
            setVal('customSpecialty', data.customSpecialty);

            if(data.directCommunication) {
                setVal('directCommunication.communicationTarget', data.directCommunication.communicationTarget);
                setVal('directCommunication.communicationWhen', data.directCommunication.communicationWhen);
                setVal('directCommunication.communicationMethod', data.directCommunication.communicationMethod);
                setVal('directCommunication.communicationSituations', data.directCommunication.communicationSituations);
            }
            if(data.apologySettings) {
                Object.keys(data.apologySettings).forEach(k => setBool(`apologySettings.${k}`, data.apologySettings[k]));
            }
            if(data.ragConfig) {
                setVal('ragConfig.corpusId', data.ragConfig.corpusId || data.ragConfig.vectorStoreId);
                setVal('ragConfig.mode', data.ragConfig.mode);
                setVal('ragConfig.topK', data.ragConfig.topK);
            }

            // SCHEDULING
            const sched = data.scheduling || {};
            setVal('timeBetweenAppointments', sched.timeBetweenAppointments);
            setVal('maxDaysBeforeBooking', sched.maxDaysBeforeBooking);
            setVal('minAppointmentBuffer', sched.minAppointmentBuffer);
            setVal('appointmentSchedulingPreference', sched.appointmentSchedulingPreference);
            setVal('otherCalendarLink', sched.otherCalendarLink);
            setBool('smartSearch', sched.smartSearch);
            if(sched.agendarCitaFields) {
                setBool('agendarCitaFields.requestEmail', sched.agendarCitaFields.requestEmail);
                setBool('agendarCitaFields.requestMotivoDeCita', sched.agendarCitaFields.requestMotivoDeCita);
            }
            // Lists
            document.getElementById('appointmentTypesList').innerHTML = '';
            if(sched.appointmentTypes) Object.keys(sched.appointmentTypes).forEach(k => addAppointmentType({key:k, ...sched.appointmentTypes[k]}));
            document.getElementById('doctorsList').innerHTML = '';
            if(sched.doctors) Object.keys(sched.doctors).forEach(k => addDoctor({key:k, ...sched.doctors[k]}));
            document.getElementById('outOfOfficeList').innerHTML = '';
            if(sched.outOfOffice) sched.outOfOffice.forEach(evt => addOutOfOffice(evt));

            // MEDIA
            const med = data.media || {};
            setBool('enableMediaSending', med.enableMediaSending);
            setVal('assetLimit', med.assetLimit);
            document.getElementById('mediaAssetsList').innerHTML = '';
            if(med.mediaAssets) Object.keys(med.mediaAssets).forEach(k => addMediaAsset({key:k, ...med.mediaAssets[k]}));

            // ROUTING
            const route = data.customNotifications || {};
            document.getElementById('routingList').innerHTML = '';
            if(route.teamTransferRules) Object.keys(route.teamTransferRules).forEach(k => addRoutingRule({key:k, ...route.teamTransferRules[k]}));

            // REMINDERS
            const rem = data.reminders || {};
            setBool('sendReminders', rem.sendReminders);
            setBool('requireConfirmation', rem.requireConfirmation);
            setVal('numberOfReminders', rem.numberOfReminders);
            if(rem.reminder1) { setVal('reminder1.timing', rem.reminder1.timing); setVal('reminder1.templateName', rem.reminder1.templateName); }
            if(rem.reminder2) { setVal('reminder2.timing', rem.reminder2.timing); setVal('reminder2.templateName', rem.reminder2.templateName); }

            // TEMPLATES
            document.getElementById('templatesList').innerHTML = '';
            if(data.templates) Object.keys(data.templates).forEach(k => addTemplate({key:k, ...data.templates[k]}));

            // TOKENS
            const tok = data.tokens || {};
            if(tok.googleCalendar) {
                setVal('tokens.gc.accessToken', tok.googleCalendar.accessToken);
                setVal('tokens.gc.refreshToken', tok.googleCalendar.refreshToken);
                setVal('tokens.gc.expiresDatetime', tok.googleCalendar.expiresDatetime);
            }
            if(tok.whatsappCloudApi) {
                setVal('tokens.wa.phoneNumberId', tok.whatsappCloudApi.phoneNumberId);
                setVal('tokens.wa.wabaId', tok.whatsappCloudApi.wabaId);
                setVal('tokens.wa.token', tok.whatsappCloudApi.token);
            }
        }

        function saveConfigFile() {
            const data = getFormData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.assistantName || 'config'}_full.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('Saved successfully!');
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(JSON.stringify(getFormData(), null, 2));
            showToast('Copied to clipboard!');
        }

        function loadConfigFile(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = e => { populateForm(JSON.parse(e.target.result)); showToast('Loaded!'); input.value = ''; };
            r.readAsText(file);
        }
    </script>
</body>
</html>
